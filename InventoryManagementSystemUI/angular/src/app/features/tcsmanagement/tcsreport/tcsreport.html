<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5>TCS (Tax Collected at Source)</h5>
        <span class="d-block m-t-5">TCS Report for B2C Jewellery Sales - Section 206C(1H)</span>
      </div>
      <div class="card-body">
        <!-- Filters -->
        <div class="row mb-4">
          <div class="col-md-4">
            <label class="form-label">Financial Year</label>
            <input type="text" class="form-control" [(ngModel)]="financialYear" placeholder="e.g., 2024-25" (change)="onFilterChange()" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Quarter</label>
            <select class="form-select" [(ngModel)]="selectedQuarter" (change)="onFilterChange()">
              <option [ngValue]="null">All Quarters</option>
              <option *ngFor="let q of quarters" [ngValue]="q.value">{{ q.label }}</option>
            </select>
          </div>
        </div>

        <!-- Tabs -->
        <ul class="nav nav-tabs mb-3">
          <li class="nav-item">
            <a class="nav-link" [class.active]="activeTab === 'dashboard'" (click)="onTabChange('dashboard')" style="cursor: pointer;">
              Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" [class.active]="activeTab === 'transactions'" (click)="onTabChange('transactions')" style="cursor: pointer;">
              Transactions
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" [class.active]="activeTab === 'form26q'" (click)="onTabChange('form26q')" style="cursor: pointer;">
              Form 26Q
            </a>
          </li>
        </ul>

        <!-- Loading Spinner -->
        <div *ngIf="isLoading" class="text-center py-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>

        <!-- Dashboard Tab -->
        <div *ngIf="activeTab === 'dashboard' && dashboardSummary && !isLoading">
          <!-- Summary Cards -->
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h6 class="text-muted">Total TCS Collected</h6>
                  <h3 class="text-primary">{{ formatCurrency(dashboardSummary.totalTcsCollected) }}</h3>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h6 class="text-muted">Total Transactions</h6>
                  <h3 class="text-info">{{ dashboardSummary.totalTransactions }}</h3>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h6 class="text-muted">Total Customers</h6>
                  <h3 class="text-success">{{ dashboardSummary.totalCustomers }}</h3>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card bg-light">
                <div class="card-body text-center">
                  <h6 class="text-muted">Total Sales Amount</h6>
                  <h3 class="text-warning">{{ formatCurrency(dashboardSummary.totalSaleAmount) }}</h3>
                </div>
              </div>
            </div>
          </div>

          <!-- Quarterly Summary -->
          <div class="row">
            <div class="col-12">
              <h6>Quarterly Summary - FY {{ dashboardSummary.financialYear }}</h6>
              <div class="table-responsive">
                <table class="table table-striped">
                  <thead>
                    <tr>
                      <th>Quarter</th>
                      <th>TCS Collected</th>
                      <th>Transactions</th>
                      <th>Sale Amount</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let q of dashboardSummary.quarterlySummaries">
                      <td>{{ q.quarterDescription }}</td>
                      <td>{{ formatCurrency(q.tcsCollected) }}</td>
                      <td>{{ q.transactionCount }}</td>
                      <td>{{ formatCurrency(q.saleAmount) }}</td>
                    </tr>
                    <tr *ngIf="dashboardSummary.quarterlySummaries.length === 0">
                      <td colspan="4" class="text-center text-muted">No data available</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Transactions Tab -->
        <div *ngIf="activeTab === 'transactions' && !isLoading">
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>Invoice #</th>
                  <th>Customer</th>
                  <th>PAN</th>
                  <th>Transaction Date</th>
                  <th>Sale Amount</th>
                  <th>Cumulative</th>
                  <th>TCS Rate</th>
                  <th>TCS Amount</th>
                  <th>Type</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let txn of transactions">
                  <td>{{ txn.invoiceNumber }}</td>
                  <td>{{ txn.customerName }}</td>
                  <td>
                    <span *ngIf="txn.panNumber">{{ txn.panNumber }}</span>
                    <span *ngIf="!txn.panNumber" class="text-muted">N/A</span>
                  </td>
                  <td>{{ formatDate(txn.transactionDate) }}</td>
                  <td>{{ formatCurrency(txn.saleAmount) }}</td>
                  <td>{{ formatCurrency(txn.cumulativeSaleAmount) }}</td>
                  <td>{{ getTcsRateDisplay(txn.tcsRate) }}</td>
                  <td class="fw-bold">{{ formatCurrency(txn.tcsAmount) }}</td>
                  <td>
                    <span [class]="getTcsTypeBadgeClass(txn.tcsType)">
                      {{ getTcsTypeDescription(txn.tcsType) }}
                    </span>
                  </td>
                </tr>
                <tr *ngIf="transactions.length === 0">
                  <td colspan="9" class="text-center text-muted py-4">No TCS transactions found</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Form 26Q Tab -->
        <div *ngIf="activeTab === 'form26q' && !isLoading">
          <div class="row mb-3">
            <div class="col-12">
              <div class="alert alert-info">
                <strong>Form 26Q</strong> - Quarterly statement of TCS for the quarter ending in FY {{ financialYear }}.
                Select a quarter and click "Generate Report" to view the Form 26Q data.
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <label class="form-label">Select Quarter</label>
              <select class="form-select" [(ngModel)]="selectedQuarter">
                <option [ngValue]="null">-- Select Quarter --</option>
                <option *ngFor="let q of quarters" [ngValue]="q.value">{{ q.label }}</option>
              </select>
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button class="btn btn-primary me-2" (click)="generateForm26Q()" [disabled]="!selectedQuarter">
                <i class="fas fa-file-alt me-1"></i> Generate Report
              </button>
              <button class="btn btn-success" (click)="exportToCSV()" [disabled]="!form26QReport">
                <i class="fas fa-download me-1"></i> Export CSV
              </button>
            </div>
          </div>

          <!-- Form 26Q Report -->
          <div *ngIf="form26QReport" class="mt-4">
            <div class="row mb-3">
              <div class="col-12">
                <h6>Form 26Q - {{ form26QReport.quarterDescription }} FY {{ form26QReport.financialYear }}</h6>
                <div class="row">
                  <div class="col-md-4">
                    <p class="mb-1"><strong>Total Transactions:</strong> {{ form26QReport.totalTransactions }}</p>
                  </div>
                  <div class="col-md-4">
                    <p class="mb-1"><strong>Total TCS:</strong> {{ formatCurrency(form26QReport.totalTcsCollected) }}</p>
                  </div>
                  <div class="col-md-4">
                    <p class="mb-1"><strong>Total Sales:</strong> {{ formatCurrency(form26QReport.totalSaleAmount) }}</p>
                  </div>
                </div>
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-bordered table-striped">
                <thead class="table-dark">
                  <tr>
                    <th>S.No</th>
                    <th>PAN</th>
                    <th>Name</th>
                    <th>Address</th>
                    <th>Invoice #</th>
                    <th>Date</th>
                    <th>Amount</th>
                    <th>TCS Rate</th>
                    <th>TCS Amount</th>
                    <th>Nature of Goods</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let entry of form26QReport.entries">
                    <td>{{ entry.serialNumber }}</td>
                    <td>{{ entry.collecteePAN }}</td>
                    <td>{{ entry.collecteeName }}</td>
                    <td>{{ entry.collecteeAddress || '-' }}</td>
                    <td>{{ entry.invoiceNumber }}</td>
                    <td>{{ formatDate(entry.transactionDate) }}</td>
                    <td>{{ formatCurrency(entry.amountReceived) }}</td>
                    <td>{{ entry.tcsRate }}%</td>
                    <td>{{ formatCurrency(entry.tcsAmount) }}</td>
                    <td>{{ entry.natureOfGoods }}</td>
                  </tr>
                  <tr *ngIf="form26QReport.entries.length === 0">
                    <td colspan="10" class="text-center text-muted py-4">No entries found for this quarter</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
